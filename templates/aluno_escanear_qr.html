{% extends "base.html" %}
{% block title %}Confirmar Presen√ßa{% endblock %}

{% block content %}

<section class="section">

    <!-- HEADER -->
    <div class="section-header">
        <h2 class="section-title">
            Confirmar <span>Presen√ßa</span>
        </h2>
        <p class="section-subtitle">
            Escaneie o QR Code do evento para validar sua presen√ßa
        </p>
    </div>

    <!-- HERO ICON -->
    <div class="qr-hero">
        <i class="fas fa-qrcode"></i>
    </div>

    <!-- SCANNER -->
    <div id="qr-video" class="qr-scanner"></div>

    <!-- FEEDBACK -->
    <div id="outputMessage" class="qr-message"></div>
    <div id="outputData" class="qr-data"></div>

    <!-- FORM -->
    <form id="presencaForm" method="POST" action="{{ url_for('confirmar_presenca') }}">
        <input type="hidden" name="qr_code_lido" id="qr_code_lido">
        <button type="submit" class="btn btn-primary btn-reserve pulse">
            Confirmar Presen√ßa
        </button>
    </form>

    <!-- SUCCESS OVERLAY -->
    <div id="successOverlay" class="success-overlay">
        <div class="success-card">
            <i class="fas fa-check-circle"></i>
            <h3>Presen√ßa confirmada!</h3>
            <p>Voc√™ j√° pode aproveitar o evento üéâ</p>
        </div>
    </div>

    <!-- BACK -->
    <div class="qr-back">
        <a href="{{ url_for('meus_eventos') }}" class="secondary-link">
            ‚Üê Voltar para meus eventos
        </a>
    </div>

</section>

<!-- QR LIB -->
<script src="https://rawcdn.githack.com/mebjas/html5-qrcode/master/minified/html5-qrcode.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const outputMessage = document.getElementById("outputMessage");
    const outputData = document.getElementById("outputData");
    const form = document.getElementById("presencaForm");
    const inputQr = document.getElementById("qr_code_lido");
    const overlay = document.getElementById("successOverlay");

    form.style.display = "none";

    function onScanSuccess(decodedText) {

        outputMessage.textContent = "QR Code validado com sucesso";
        outputData.textContent = decodedText;

        inputQr.value = decodedText;
        form.style.display = "block";

        document.body.classList.add("scan-success");

        setTimeout(() => {
            overlay.classList.add("show");
        }, 400);

        html5QrcodeScanner.clear();
    }

    function onScanError(error) {}

    const html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-video",
        { fps: 10, qrbox: { width: 260, height: 260 } }
    );

    html5QrcodeScanner.render(onScanSuccess, onScanError);
});
</script>

<style>
/* ===== QR PAGE FINAL STYLE ===== */

.qr-hero {
    text-align: center;
    margin-bottom: 32px;
}
.qr-hero i {
    font-size: 4.8rem;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.qr-scanner {
    max-width: 520px;
    margin: 0 auto;
    border-radius: 26px;
    overflow: hidden;
    box-shadow: 0 30px 90px rgba(0,0,0,.35);
}

.qr-message {
    margin-top: 28px;
    text-align: center;
    font-weight: 600;
    color: #16a34a;
}

.qr-data {
    margin-top: 8px;
    text-align: center;
    font-weight: 700;
    color: #0f766e;
}

#presencaForm {
    margin-top: 36px;
    text-align: center;
}

.success-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: .4s ease;
}

.success-overlay.show {
    opacity: 1;
    pointer-events: all;
}

.success-card {
    background: #fff;
    padding: 42px 36px;
    border-radius: 28px;
    text-align: center;
    animation: pop .45s ease;
}
.success-card i {
    font-size: 4rem;
    color: #22c55e;
}
.success-card h3 {
    margin-top: 18px;
    font-size: 1.5rem;
}
.success-card p {
    margin-top: 6px;
    color: #6b7280;
}

.qr-back {
    margin-top: 56px;
    text-align: center;
}

.pulse {
    animation: pulse 1.6s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(34,197,94,.5); }
    70% { box-shadow: 0 0 0 18px rgba(34,197,94,0); }
    100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
}

@keyframes pop {
    0% { transform: scale(.7); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
</style>

{% endblock %}
